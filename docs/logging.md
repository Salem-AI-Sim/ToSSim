# Logging Specification

_Version: 0.1_
_Last updated: 2025-06-18_

This document specifies the logging strategy for the ToSSim environment. The goal is to produce comprehensive, structured, and machine-readable logs to facilitate debugging, agent performance analysis, and behavioral research.

---

## 1. General Principles

*   **Format:** All logs will be written in the **line-delimited JSON (JSONL)** format. Each line in a log file is a complete, self-contained JSON object representing a single event.
*   **Timestamping:** Every log entry must have a `timestamp` field containing an ISO 8601 formatted UTC timestamp.
*   **Separation of Concerns:** To keep data clean and organized, logs are separated into distinct files, or "streams," based on their purpose.

---

## 2. Log Streams & Schemas

The environment will produce the following five log files.

### 2.1 `game_events.jsonl`
Records the high-level, objective state changes of the game itself. This log tells the story of what happened in the simulation.

*   **`timestamp`** (string): ISO 8601 timestamp.
*   **`turn`** (string): The current game turn (e.g., "Day 1", "Night 3").
*   **`event_type`** (string): The type of game event. Examples: `GAME_START`, `DAY_START`, `NIGHT_START`, `DEATH`, `VOTE_START`, `TRIAL_RESULT`, `GAME_END`.
*   **`payload`** (object): A dictionary containing event-specific data.
    *   **Example (DEATH):** `{"player": "Player 5", "role": "Doctor", "killed_by": "Mafia"}`
    *   **Example (GAME_END):** `{"winning_faction": "Town", "surviving_players": ["Player 1", "Player 7"]}`

### 2.2 `chat.jsonl`
A simple transcript of all public messages spoken by agents in the town square.

*   **`timestamp`** (string): ISO 8601 timestamp.
*   **`turn`** (string): The game turn when the message was spoken.
*   **`speaker`** (string): The player name of the agent who spoke.
*   **`message`** (string): The raw text of the message from within the `<speak>` tag.

### 2.3 `agent_actions.jsonl`
Records every discrete, game-altering action taken by an agent.

*   **`timestamp`** (string): ISO 8601 timestamp.
*   **`turn`** (string): The game turn when the action was taken.
*   **`agent`** (string): The player name of the acting agent.
*   **`action_type`** (string): The type of action. Examples: `ABILITY_USE`, `VOTE`, `TRIAL_VOTE`.
*   **`payload`** (object): A dictionary containing action-specific data.
    *   **Example (ABILITY_USE):** `{"ability": "investigate", "target": "Player 4"}`
    *   **Example (VOTE):** `{"voter": "Player 7", "target": "Player 4"}`
    *   **Example (TRIAL_VOTE):** `{"voter": "Player 1", "verdict": "guilty"}`

### 2.4 `agent_reasoning.jsonl`
Provides a direct window into each agent's thought process. This is invaluable for behavioral analysis and debugging agent logic.

*   **`timestamp`** (string): ISO 8601 timestamp.
*   **`turn`** (string): The game turn.
*   **`agent`** (string): The player name of the thinking agent.
*   **`thinking_process`** (string): The full, raw string from between the agent's `<thinking>` and `</thinking>` tags, including any tool calls it made.

### 2.5 `inference_trace.jsonl`
Low-level performance and debugging logs from the Inference Engine. This is used to diagnose technical issues with the LLM serving layer.

*   **`timestamp`** (string): ISO 8601 timestamp.
*   **`event_type`** (string): The type of inference event. Examples: `AGENT_REQUEST`, `TOOL_CALL`, `TOOL_RESULT`, `INFERENCE_COMPLETE`.
*   **`agent`** (string): The player name of the agent involved.
*   **`payload`** (object): A dictionary containing event-specific data.
    *   **Example (INFERENCE_COMPLETE):** `{"latency_ms": 4512, "prompt_tokens": 1250, "output_tokens": 88}`
    *   **Example (TOOL_CALL):** `{"tool_name": "check_will", "arguments": "Player 3"}`
    *   **Example (TOOL_RESULT):** `{"tool_name": "check_will", "result": "Player 3's Will: ..."}`

**Usage for Blind Judging:**
This structure allows a judge to analyze potential deception by comparing an agent's external and internal states:
1.  **External Pass:** The judge is shown only the `full_chat_log` and the `action_log`.
2.  **Internal Pass:** The judge is shown the same information, but with the `reasoning_log` added to see if the agent's private thoughts align with its public actions and statements.

### 2.3 `sft_dataset.jsonl`
A line-delimited JSON file where each line is a single prompt/response pair from the game, formatted for Supervised Fine-Tuning (SFT). This dataset is generated from all gameplay and can be used to continuously improve agent performance in a separate research track.

*   **`prompt`** (string): The full input provided to the model for a given turn. This includes the system prompt, the dynamic turn-based context (roster, logs, chat history), and the opening `<user>` tag.
*   **`completion`** (string): The full, raw response generated by the agent for that turn. This includes the entire `<assistant>` block, with the `<thinking>` process and the final `<speak>` or `<wait>` action.
*   **`metadata`** (object): Additional data for filtering and analysis.
    *   `game_id` (string): The identifier for the game session.
    *   `agent_name` (string): The name of the agent who generated the completion.
    *   `agent_role` (string): The role of the agent.
    *   `turn` (string): The game turn. 